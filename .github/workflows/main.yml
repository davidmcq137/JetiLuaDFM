name: CI
on:
  push:
    branches: [master, beta]
jobs:
  build:
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v2
      - name: Checkout lua_jeti repo
        uses: actions/checkout@v2
        with:
          repository: fazzone/lua_jeti
          path: lua_jeti
      - name: Build lua itself
        shell: bash
        run: |
          set -ex
          cd lua_jeti
          make -j4 linux
      - name: Install dependencies
        shell: bash
        run: "sudo apt-get install -y jq sox"
      - name: Build LC
        id: lc_build
        shell: bash
        run: "lua_jeti/src/lua build/script.lua"
      - name: Upload release asset
        if: ${{ github.ref == 'refs/heads/master' }}
        id: upload-release-asset 
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: release-v${{ steps.lc_build.outputs.dfm_maps_version }}
          name: "DFM-Maps Version ${{ steps.lc_build.outputs.dfm_maps_version }}"
          files: |
            release-output/*
      - name: Upload dev asset
        if: ${{ github.ref == 'refs/heads/dev' }}
        id: upload-dev-asset 
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: true
          tag_name: prerelease-v${{ steps.lc_build.outputs.dfm_maps_version }}-${{ github.run_id }}
          name: "DFM-Maps Pre-Release ${{ steps.lc_build.outputs.dfm_maps_version }} #${{ github.run_id }}"
          files: |
            release-output/*
